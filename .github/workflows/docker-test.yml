name: Docker Compose Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Ð ÑƒÑ‡Ð½Ð¾Ð¹ Ð·Ð°Ð¿ÑƒÑÐº

jobs:
  docker-compose-test:
    name: Run Docker Compose
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Create .env file
      run: |
        cat > .env << EOF
        POSTGRES_USER=shop_user
        POSTGRES_PASSWORD=shop_password
        POSTGRES_DB=shop_db
        SECRET_KEY=test-secret-key-for-github-actions
        DEBUG=True
        EOF

    - name: Build and start services
      run: |
        docker compose up -d --build

    - name: Wait for services to be ready
      run: |
        echo "â³ Waiting for services to start..."
        sleep 60

    - name: Check running containers
      run: |
        echo "ðŸ“¦ Running containers:"
        docker compose ps
        
    - name: Check PostgreSQL
      run: |
        docker compose exec -T postgres pg_isready -U shop_user && echo "âœ… PostgreSQL is ready"

    - name: Check Redis
      run: |
        docker compose exec -T redis redis-cli ping && echo "âœ… Redis is ready"

    - name: Run database migrations
      run: |
        echo "ðŸ”„ Running migrations..."
        docker compose exec -T user-service python manage.py migrate --noinput
        docker compose exec -T product-service python manage.py migrate --noinput
        docker compose exec -T cart-service python manage.py migrate --noinput
        docker compose exec -T order-service python manage.py migrate --noinput
        docker compose exec -T currency-service python manage.py migrate --noinput
        docker compose exec -T discount-service python manage.py migrate --noinput

    - name: Run unit tests
      run: |
        echo "ðŸ§ª Running tests..."
        docker compose exec -T user-service python manage.py test apps.users.tests --verbosity=1
        docker compose exec -T product-service python manage.py test apps.products.tests --verbosity=1
        docker compose exec -T cart-service python manage.py test apps.cart.tests --verbosity=1
        docker compose exec -T order-service python manage.py test apps.orders.tests --verbosity=1
        docker compose exec -T currency-service python manage.py test apps.currency.tests --verbosity=1
        docker compose exec -T discount-service python manage.py test apps.discounts.tests --verbosity=1

    - name: Test API endpoints
      run: |
        echo "ðŸŒ Testing API endpoints..."
        curl -f http://localhost:8000/api/health/ || echo "âš ï¸ API Gateway health check"
        curl -f http://localhost:8001/api/products/ || echo "âš ï¸ Product Service"
        curl -f http://localhost:3000/ || echo "âš ï¸ Frontend"

    - name: Show logs on failure
      if: failure()
      run: |
        echo "ðŸ“‹ Service logs:"
        docker compose logs --tail=100

    - name: Cleanup
      if: always()
      run: |
        docker compose down -v
